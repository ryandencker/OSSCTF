#include <stdio.h>
#include <stdlib.h>
#include <stdbool.h>
#include <string.h>
#include <time.h>
#include <unistd.h>
#include <sys/time.h>
#include <sys/types.h>


#define WAIT 60



static const char* flag = "OSSCTF{[REDACTED]}";

char* hands[2] = {"left", "right"};
char* loses[2] = {"left", "right"};
int wins = 0;



int tgetinput(char *input, unsigned int l)
{
    fd_set          input_set;
    struct timeval  timeout;
    int             ready_for_reading = 0;
    int             read_bytes = 0;
    
    if( l <= 0 )
    {
      printf("'l' for tgetinput must be greater than 0\n");
      return -2;
    }
    
    

    FD_ZERO(&input_set );
    FD_SET(STDIN_FILENO, &input_set);

    timeout.tv_sec = WAIT;   
    timeout.tv_usec = 0;   

    ready_for_reading = select(1, &input_set, NULL, NULL, &timeout);

    if (ready_for_reading == -1) {
        printf("Unable to read your input\n");
        return -1;
    } 

    if (ready_for_reading) {
        read_bytes = read(0, input, l-1);
        if(input[read_bytes-1]=='\n'){
        --read_bytes;
        input[read_bytes]='\0';
        }
        if(read_bytes==0){
            printf("No data given.\n");
            return -4;
        } else {
            return 0;
        }
    } else {
        printf("Timed out waiting for user input. Press Ctrl-C to disconnect\n");
        return -3;
    }

    return 0;
}


bool play () {
  char player_turn[100];
  srand(time(0));
  int r;

  printf("Which hand will you choose? (left/right):\n");
  r = tgetinput(player_turn, 100);
  if(r == -3)
  {
    printf("Goodbye!\n");
    exit(0);
  }

  int computer_turn = rand() % 2;
  printf("You choose: %s\n", player_turn);
  printf("The flag was in my #%s hand!!!\n", hands[computer_turn]);

  if (strstr(player_turn, loses[computer_turn])) {
    puts("You win! Play again?");
    return true;
  } else {
    puts("Seems like you didn't win this time. Play again?");
    return false;
  }
}


int main () {
  char input[3] = {'\0'};
  int command;
  int r;

  puts("I have a flag in one of my hands");
  puts("If anyone is able to guess which hand im holding it in 10 times in a row, I will give them the flag");
  puts("Good luck, you are going to need it");
  
  while (true) {
    if (wins < 10){
      printf("\nyou only need %d more wins!\n\n", 10-wins);
    }

    puts("Type '1' to guess which hand the flag is in");
    puts("Type '2' to exit the program");
    
    r = tgetinput(input, 3);
    // Timeout on user input
    if(r == -3)
    {
      printf("Goodbye!\n");
      exit(0);
    }


    if ((command = strtol(input, NULL, 10)) == 0) {
      puts("Please put in a valid number");
      
    } else if (command == 1) {
      printf("\n\n");
      if (play()) {
        wins++;
      } else {
        wins = 0;
      }

      if (wins >= 10) {
        puts("Congrats, here's the flag!");
        puts(flag);
      }
    } else if (command == 2) {
      puts("Maybe next time...");
      return 0;
    } else {
      puts("Please type either 1 or 2");
    }
  }

  return 0;
}

